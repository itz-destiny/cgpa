/**
 * @file Firebase Security Rules for GradeRight application.
 *
 * @core_philosophy This ruleset enforces a strict user-ownership model for user profiles and their associated data (semesters, courses).
 *   Admins can create users, but only users can modify their own profiles and data. No data validation is performed beyond authorization checks.
 *
 * @data_structure
 * - /users/{userId}: Stores user profile information, accessible only to the user themselves (and potentially admins - see below).
 * - /users/{userId}/semesters/{semesterId}: Stores semester data for each user, accessible only to the user themselves.
 *
 * @key_security_decisions
 * - User Listing: Listing all users is explicitly denied for non-admin users to protect privacy.
 * - Admin Role: While the data model includes an 'admin' role, this initial ruleset does not implement any admin-specific privileges beyond user creation. Admin-specific actions will need to be explicitly defined in future iterations.
 * - Data Validation: In this prototype phase, data validation is omitted to allow for rapid iteration. The rules focus solely on authorization.
 *
 * @denormalization_for_authorization The rules rely on the `request.auth.uid` to match the `userId` path parameter to enforce user-ownership.
 *   Additionally, the role of the user is checked for allowing user creation.
 *
 * @structural_segregation There is no need for structural segregation as private data is stored under user-specific paths.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants access to user profile information.
     * @path /users/{userId}
     * @allow (get, create, update, delete, list) if the user is the owner of the profile.
     * @deny (get, create, update, delete, list) if the user is not the owner of the profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isAdmin() {
          return request.auth.token.role == 'admin';
      }

      // function canCreateUser() {
      //   return isAdmin()
      // }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false; // Listing all users is not permitted for non-admins
      allow create: if isSignedIn() && isOwner(userId) ;
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Grants access to semesters for a specific user.
     * @path /users/{userId}/semesters/{semesterId}
     * @allow (get, create, update, delete, list) if the user is the owner of the parent user document.
     * @deny (get, create, update, delete, list) if the user is not the owner of the parent user document.
     * @principle Enforces document ownership for all operations within the user's data tree.
     */
    match /users/{userId}/semesters/{semesterId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }
  }
}